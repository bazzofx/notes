## Attacking Normalization by the origin server[](https://portswigger.net/web-security/learning-paths/web-cache-deception/wcd-using-normalization-discrepancies/web-cache-deception/lab-wcd-exploiting-origin-server-normalization)
## **1. Check if cache/origin resolve ..**
If the origin server resolves encoded dot-segments, but the cache doesn't, you can attempt to exploit the discrepancy by constructing a payload according to the following structure:

	-`url: /<static-directory-prefix>/..%2f<dynamic-path>`

For example, consider the payload `/assets/..%2fprofile`:
- The cache interprets the path as: **/assets/..%2fprofile**
- The origin server interprets the path as: **/profile**

## Attack Method
1. Identify if the endPoint is canonicalize[](https://en.wikipedia.org/wiki/Canonicalization) path or not, check if  **/assets/..%2fprofile** returns same information as **/profile**
2. Find cache paths to try, usually static folder assets, .css .js
3. Also check if cache server is checking for normalization  if **/assets/..%2fjs/stockCheck.js** resolves **/assets/js/stockCheck.js** 
4. Identify if files are been cached, or entire folders 
5. Test payload on sensitive endpoint that is canonicalizing the path with the cached path so **/assets/../profile**
6. Now let's add a cache key **/assets/../profile?a=b.js**
7. If we get cache miss, send again and cache=hit we have a found a bug
8. If path gets normalize on server with **/** use **%2f** instead
9. Deliver payload to victim, once he clicks on it, go to url will be cache with his information
10. payload 
```html
<body>
<script>window.location="website/assets/..%2fprofile?a=omg.js</script>
</body>
```
> The origin server returns the dynamic profile information, which is stored in the cache.

> We can also brute force the delimeter, instead **?** use something else (ie: pbbug/fuzzing/delimiter-list.txt)


---
### Detecting normalization by the origin server
To test how the origin server normalizes the URL path, send a request to a non-cacheable resource with a path traversal sequence and an arbitrary directory at the start of the path. To choose a non-cacheable resource, look for a non-idempotent method like `POST`. For example, modify **/profile**  to  **/aaa/..%2fprofile**

- If the response matches the base response and returns the profile information, this indicates that the path has been interpreted as `/profile`. The origin server decodes the slash and resolves the dot-segment.
- If the response doesn't match the base response, for example returning a `404` error message, this indicates that the path has been interpreted as `/aaa/..%2fprofile`. The origin server either doesn't decode the slash or resolve the dot-segment.


> Start by encoding only the second slash on the dot-segment. Some CDNs got rules on how to match and cache the request
> Try encoding the full path traversal sequence
> Try encoding a dot instead of the slash.